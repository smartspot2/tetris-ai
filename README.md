# tetris-ai

A Tetris AI built with [p5.js](https://p5js.org).

## Overview

This AI generates a list of all possible end states of the current piece, and picks the one with the highest fitness
score. In case of a tie, the AI picks a state at random.

### AI Design

The list of all possible end states is generated by running a breadth-first-search through all possible control inputs
at every possible point in time, attempting to hard-drop at each step along the way.

This brute-force search enables the AI to perform complex maneuvers, like T-spins, tucks, and slides. Although wall
kicks are not implemented just yet, the AI will also be able to make use of such techniques as-is.

Further, the AI also takes into account the next move when deciding the current move; if a sacrifice in fitness score
for the current move allows for a much better move for the next piece, it will make the sacrifice. For optimization,
only the top 25% of current moves will be looked at when considering the next turn.

The amount of improvement needed is configurable, though it should be noted that the value must be picked with care.
Too little required improvement causes the AI to overfit to the next move, always making poor decisions to save the best move
for the next turn, while never getting the chance to make the good move. Too much required improvement reduces the
strategy to only paying attention to the current move, meaning beneficial sacrifices will never be made (while also
wasting computation in looking at the next move).

Several optimizations in hashing and caching were made to speed up the process, but the brute-force search takes a
visually noticeable amount of time (about 100ms on average to calculate the best move); this is a point of improvement
in the future.

### Fitness Score

The fitness score is determined by several factors:

* Line clears (reward for line clears)
* Gaps (penalty for creating a gap, but less penalty after the first gap is created in the column)
* Height distribution (penalty for a larger average height difference in adjacent columns)
* Piece height placement/board height (penalty when placed higher, increasing with the square of the height)

The weights of each factor were determined manually through testing.

## Gameplay

The rest of the Tetris gameplay is quite standard, and built off of
the [Tetris guidelines](https://tetris.fandom.com/wiki/Tetris_Guideline).

The pieces are [drawn from a bag](https://tetris.fandom.com/wiki/Random_Generator), meaning all 7 pieces are
guaranteed to appear in some order before refilling the bag.

Rotations were implemented based on the [SRS (Super Rotation System)](https://tetris.fandom.com/wiki/SRS)
guidelines, but no wall kicks or other techniques are implemented yet; there is only functionality for the basic
rotations.

Keyboard mappings are standard as well, with the left/right arrow keys moving the pieces left/right, the up arrow
rotating clockwise, the down arrow as a soft drop, and the `Z` key rotating counterclockwise. Holding a piece is done
with the shift key, and a hard drop is the space.

The ghost piece is enabled by default (and cannot be disabled at the moment). It should be noted that it is quite
similar visually to the display color of the target end state of the AI, and may be changed in future versions.

However, there are a few aspects of the standard game described by the guidelines that are not currently implemented.

There is currently no scoring system, and the only means of scoring is the number of lines cleared. Drop speed is
currently static (can be changed in the settings menu) and not variable based on line clears. There is also no DAS
(auto-repeat) support at the moment, as it is tricky to implement the delay and balance the sensitivity.

## Settings

The main UI currently has several settings that can be changed on the fly during the game.

* **Enable AI**: Starts AI, but will still detect keyboard input

* **AI Delay**: Number of frames between AI moves.
  If this is greater than or equal to 0, the AI will wait until the piece comes on screen before making its first move.
  If this is equal to -1, the AI will immediately execute its sequence of moves when the piece is generated.

  The current target (chosen) end state will be displayed on teh board in a light color.

* **Frame Rate**: Maximum number of frames per second that p5.js should run at.

* **Drop Frames**: Number of frames to wait before gravity drops the current piece down one row.

* **Show Hints**: Utilizes the AI to suggest the best possible move to make given the current board state.
  If there are multiple best moves (i.e. multiple moves with the same fitness score), it will display all of them. Note
  that this may cause some visual noise when there are a lot of possibilities, as they may overlap.

There are additional configuration options in the configuration file `src/config.js`, but should not be modified, as
they may mess up the visual appearance of the p5.js canvas.

## Bugs/Improvements

This project is currently under development, but feel free to create an issue for any bugs, or to suggest any
improvements or features!
